# Введение в IoT (семинары)

Этот [репозиторий](https://github.com/allseenn/iot) содержит установочные скрипты bash и документацию.

README - в данном руководстве описаны практические работы (ДЗ) по курсу "Введение в IOT". 

Онлайн университет: GeekBrains

Группа: Инженер умных устройств

Студент: Ростислав Ромашин 

## Урок 1. Развертывание своей системы визуализации

Все описанной в разделе выполнялась на операционной системе Ubuntu 22.04.3 LTS с использованием Docker version 24.0.6 build ed223bc.

Все действия рекомендую проводить от имени суперпользователя root.

### Быстрый старт

Копируем команду представленную ниже и вставляем в терминал системы.

```
wget https://github.com/allseenn/iot/raw/main/install.sh -O install.sh && bash install.sh
```

В результате запустится скрипт развертывания системы на основе docker контейнеров:

- mosquitto
- telegraf
- influxdb
- grafana
- node-red
- wireguard

Логин и пароль для всех служб по умолчанию одинаковый, во избежании путаницы:
- user: admin
- pass: students

ВНИМАНИЕ: Из-за требований безопасности одной из служб общий пароль должен быть не менее 8 символов. Поэтому students - во множественном числе с s на конце.

После установки через веб-браузер заходим на адреса, которые будут опубликованы скриптом перед завершением работы.

Порты для служб по умолчанию:
- mosquitto 1883/tcp
- telegraf 8092/udp, 8125/udp, 8094/tcp
- influxdb 8080/tcp
- grafana 3000/tcp
- node-red 1880/tcp
- wireguard 51820/udp

Вся служебная информация: логины, пароли, адреса и порты, токены, будет сохранена в файле ~/info.txt после завершения скрипта установки.

### Описание

Предлагаю два скрипта:

- install.sh
- uninstall.sh

#### install.sh

Установочный bash скрипт в начале кода содержит константы, которые можно изменить по своему усмотрению:

- USERNAME - имя пользователя, одинаковое для всех служб
- PASSWORD - пароль не менее 8 символов, одинаковый для всех служб
- ORG - организация
- BUCKET - карзина
- INFLUXDB_TOKEN - токен базы InfluxDB

Вышеперечисленные константы можно оставить по умолчани.

Константы перечисленные ниже:

LOC_IP - локальный ip-адрес
PUB_IP - публичный ip-адрес
ALL_IP - маска, означающая - все адреса
DOCKER_VERSION - требуемая версия докера, если версия ниже происходит автоматическое обновление до последней.

Значение последних четырех констант вычисляются автоматически, но могут быть откорректирован на свое усмотрение.

Загрузить скрипт на систему Ubuntu можно несколькими способами:
- с помощью git
- wget, curl
- copy & pase

В любом случае, после сохранения скриптов на свою систему, необходимо выставить на них бит исполнения:

```
chmod 700 *.sh
./install.sh
```

Либо запускать скрипт как аргумент интерпретатора:

```
bash install.sh
```

Первым делом  скрипт install.sh проверит наличие docker и его версию, в случае отсутствия либо низкой версии программы, будет произведена установка.

Скрипт автоматически создаст в домашней директории пользователя (в случае рута в /root) структуру каталогов и в них конфигурационные файлы, которые автоматически будут примонтированы к соответствующим докер контейнерам.

В конце работы скрипта будет выведена информация о локальных и публичных адресах и портах каждой службы.

Проброс портов через роутер в данном руководстве не рассматривается, предполагается что вы знакомы с курсом "Компьютерные сети".

Так же будет создано несколько конфигураций для ВПН WireGuard. И в терменал будет выведен QR-код клиента.

Информация по настройке и установке WireGuard клиента не рассматривается, а может быть получена с [оффсайта](https://www.wireguard.com/quickstart/).

<img src=pics/01.png>

**Пример финального вывода служебной информации установочного скрипта install.sh**

В результате работы install.sh будет произведен деплой полностью рабочей системы. С настроенными паролями для каждой службы.

Более того, с помощью API графаны мне удалось создать datasource источник подключения к influxdb.

Скорее всего всю работу проведенную в первом занятии по настройке и визуализации можно сделать с помощью API служб и их команд. Но, это следующий этап )



#### uninstall.sh

Скрипт деинсталляции, позволяет полностью удалить развернутые контейнеры их конфиги и виртуальные сетевые интерфейсы.

В процессе экспериментов и настройки установочного скрипта, для ускорения процесса разработки использовал команду:

```
./uninstall.sh && ./install.sh
```
Это позволяет одной строкой удалить старый набор контейнеров и установить новый измененный.


### Скрины

#### mosquitto

Зайдя в shell контейнера mosquitto, можно отправлять события 

```
$ docker exec -it mosquitto sh
/ # mosquitto_pub -h 192.168.1.8 -p 1883 -t "GB/Temp" -m "28.5" -u "admin" -P "students"

```

Скрипт получения данных

```
from(bucket: "IoT")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "mqtt_consumer")
  |> filter(fn: (r) => r["_field"] == "value")
  |> aggregateWindow(every: v.windowPeriod, fn: mean, createEmpty: false)
  |> yield(name: "mean")
```